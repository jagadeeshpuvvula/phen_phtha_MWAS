---
title: "04_enrichment_figs"
author: "Puvvula"
date: "2024-01-08"
output: pdf_document
---

#read merged pathway analysis results
```{r}
dat <- read_csv("~/Documents/phth_phe_MWAS/result/enrich_results_combined.csv") |>
  clean_names() |>
  rename(p_gamma = "gamma", 
         pathway = "x") |>
  filter(p_gamma < 0.05) |>
  mutate(logp = -log10(p_gamma), enrichment = hits_sig/expected) |>
  mutate(enrichment_disc = cut(enrichment, breaks = seq(0, 10, by = 2), 
                                 labels = c("< 2", "2 - <4", "4 - <6",
                                            "6 - <8", "8 - 10"))) |>
  filter(pathway_total > 3) |>
  filter((chemical == "BP-A" & mom_baby %in% c("Maternal", "Newborn")) |
         (chemical == "BP-S" & mom_baby == "Maternal") |
         (chemical == "2,5-DCP" & mom_baby == "Newborn") |
         (chemical == "MBP" & mom_baby == "Newborn") |
         (chemical == "MiBP" & mom_baby == "Maternal") |
         (chemical == "MBzP" & mom_baby == "Newborn")
         )
```

#add KEGG supergroups to the pathway analysis results
```{r}
# Applying the function to your dataset
dat <- assignGroup(dat, 
                     pathway_column = "pathway", 
                     pathways = pathways)
```

#define sequence of the KEGG supergroups
```{r}
dat$group<- factor(dat$group, levels = c( "amino acid", "Carbohydrate",
                                          "Glycan", "Lipid",
                                          "Cofactors_vitamins",
                                          "Energy",
                                          "Nucleotide", "Other_secondary_metabolites", "Terpenoids_polyketides",
                                          "Xenobiotics", "other"))
```

#pathway heatmap - Plot
```{r}
dat|>
  ggplot(aes(x = factor(chemical, levels = c("2,5-DCP", 
                                             "BP-A", "BP-S",
                                             "MBP", "MiBP", "MBzP")), 
             y = pathway)) + 
  geom_tile(aes(fill = factor(enrichment_disc)), color = "black") +
  scale_color_viridis(discrete = TRUE) +
  xlab("") +
  ylab("") +
  theme_bw() +
  theme(axis.text=element_text(size=10), 
        axis.title=element_text(size=10,face="bold"),
        strip.text = element_text(size=10),
        legend.text=element_text(size=10),
        legend.title=element_text(size=10),
        legend.position="bottom",
        legend.justification="right",
        legend.box="horizontal",
        legend.box.just="center",
        legend.margin=margin(t=0.1, r=0.1, b=2, l=0.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1, size = 10),
        axis.text.y = element_text(size = 10), 
        panel.spacing.x=unit(0.8, "lines"),
        panel.spacing.y=unit(0.02, "lines"),
        strip.text.y = element_blank()
        )+
  guides(fill = guide_legend(nrow = 1))+
  facet_grid(group~ mom_baby, scales = "free", switch = "y", space = "free")+
  labs(fill = "Enrichment factor")
```

```{r}
ggsave("~/Documents/phth_phe_MWAS/result/pathway_enrich.tiff", 
       width = 8, height = 14, dpi=300)
```

#Pathway overlap plots - data prep
```{r}
dat_olap <- dat |>
  unite(filename, chemical, mom_baby, sep = " ") |>
  dplyr::select(pathway, filename) |>
  distinct(pathway, filename, .keep_all=TRUE) |>
  unnest(cols = filename) |>
  mutate(GenreMember=1) |>
  pivot_wider(names_from = filename, values_from = GenreMember, values_fill = list(GenreMember = 0)) |>
  as.data.frame() |>
  dplyr::select(`2,5-DCP Newborn`, 
                `BP-A Newborn`, 
                `MBP Newborn`, 
                `MBzP Newborn`,
                `BP-A Maternal`, 
                `BP-S Maternal`, 
                `MiBP Maternal`)
```

#overlap plots
```{r}
upset(dat_olap, 
      keep.order = TRUE,
      nsets = 20,
      sets.bar.color = c("#0072B2", "#0072B2", "#0072B2", "#0072B2", "#E69F00", "#E69F00", "#E69F00"),
      sets = c("2,5-DCP Newborn", "BP-A Newborn", "MBP Newborn", "MBzP Newborn", "BP-A Maternal", "BP-S Maternal", "MiBP Maternal"),
      set_size.show = TRUE,
      text.scale = 1.5, point.size = 4, line.size = 1,
      mainbar.y.max = 8,
      set_size.scale_max = 73,
      mainbar.y.label="No.of pathways \noverlapped across chemical biomarkers",
      sets.x.label="Total no.of \naltered pathways")
```

#=============================================================================#
#=============================================================================#
#Pathway overlap plots - data prep
```{r}
dat_olap_crazy <- dat |>
  unite(filename, chemical, mom_baby, group, sep = " ") |>
  dplyr::select(pathway, filename) |>
  distinct(pathway, filename, .keep_all=TRUE) |>
  unnest(cols = filename) |>
  mutate(GenreMember=1) |>
  pivot_wider(names_from = filename, values_from = GenreMember, values_fill = list(GenreMember = 0)) |>
  as.data.frame() |>
  dplyr::select(`2,5-DCP Newborn Carbohydrate`,
`2,5-DCP Newborn amino acid`,
`2,5-DCP Newborn Other_secondary_metabolites`,
`2,5-DCP Newborn Cofactors_vitamins`,
`2,5-DCP Newborn Glycan`,
`2,5-DCP Newborn Nucleotide`,
`2,5-DCP Newborn Energy`,
`2,5-DCP Newborn Xenobiotics`,
`2,5-DCP Newborn Lipid`,
`BP-A Maternal Cofactors_vitamins`,
`BP-A Maternal Carbohydrate`,
`BP-A Maternal amino acid`,
`BP-A Maternal Lipid`,
`BP-A Maternal Nucleotide`,
`BP-A Maternal Glycan`,
`BP-A Maternal Energy`,
`BP-A Maternal Other_secondary_metabolites`,
`BP-A Maternal Xenobiotics`,
`BP-A Newborn Xenobiotics`,
`BP-A Newborn Carbohydrate`,
`BP-A Newborn Lipid`,
`BP-A Newborn Terpenoids_polyketides`,
`BP-A Newborn amino acid`,
`BP-A Newborn Glycan`,
`BP-A Newborn Cofactors_vitamins`,
`BP-A Newborn Nucleotide`,
`BP-A Newborn Other_secondary_metabolites`,
`BP-A Newborn Energy`,
`BP-S Maternal amino acid`,
`BP-S Maternal Energy`,
`BP-S Maternal Nucleotide`,
`BP-S Maternal Cofactors_vitamins`,
`BP-S Maternal Glycan`,
`BP-S Maternal Lipid`,
`BP-S Maternal Carbohydrate`,
`BP-S Maternal Other_secondary_metabolites`,
`MBP Newborn amino acid`,
`MBP Newborn Carbohydrate`,
`MBP Newborn Cofactors_vitamins`,
`MBP Newborn Lipid`,
`MBP Newborn Xenobiotics`,
`MBP Newborn Other_secondary_metabolites`
)
```

#overlap plots
```{r}
upset(dat_olap_crazy, 
      keep.order = TRUE,
      nsets = 4,
      sets.bar.color = c(
        rep("#0072B2", 9),
        rep("#E69F00", 10),
        rep("#009E73", 6),
        rep("#56B4E9", 9),#
        rep("#FFD700", 8)
        ),
      sets = c("2,5-DCP Newborn Carbohydrate",
"2,5-DCP Newborn amino acid",
"2,5-DCP Newborn Other_secondary_metabolites",
"2,5-DCP Newborn Cofactors_vitamins",
"2,5-DCP Newborn Glycan",
"2,5-DCP Newborn Nucleotide",
"2,5-DCP Newborn Energy",
"2,5-DCP Newborn Xenobiotics",
"2,5-DCP Newborn Lipid",
"BP-A Newborn Xenobiotics",
"BP-A Newborn Carbohydrate",
"BP-A Newborn Lipid",
"BP-A Newborn Terpenoids_polyketides",
"BP-A Newborn amino acid",
"BP-A Newborn Glycan",
"BP-A Newborn Cofactors_vitamins",
"BP-A Newborn Nucleotide",
"BP-A Newborn Other_secondary_metabolites",
"BP-A Newborn Energy",
"MBP Newborn amino acid",
"MBP Newborn Carbohydrate",
"MBP Newborn Cofactors_vitamins",
"MBP Newborn Lipid",
"MBP Newborn Xenobiotics",
"MBP Newborn Other_secondary_metabolites",
"BP-A Maternal Cofactors_vitamins",
"BP-A Maternal Carbohydrate",
"BP-A Maternal amino acid",
"BP-A Maternal Lipid",
"BP-A Maternal Nucleotide",
"BP-A Maternal Glycan",
"BP-A Maternal Energy",
"BP-A Maternal Other_secondary_metabolites",
"BP-A Maternal Xenobiotics",
"BP-S Maternal amino acid",
"BP-S Maternal Energy",
"BP-S Maternal Nucleotide",
"BP-S Maternal Cofactors_vitamins",
"BP-S Maternal Glycan",
"BP-S Maternal Lipid",
"BP-S Maternal Carbohydrate",
"BP-S Maternal Other_secondary_metabolites"
),
      set_size.show = TRUE,
      text.scale = 1.5, point.size = 4, line.size = 1,
      mainbar.y.max = 6,
      set_size.scale_max = 20,
      mainbar.y.label="No.of pathways \noverlapped across chemical biomarkers",
      sets.x.label="Total no.of \naltered pathways")
```




