---
title: "04_enrichment_figs"
author: "Puvvula"
date: "2024-01-08"
output: pdf_document
---

```{r}
dat<- read_csv("~/Documents/phth_phe_MWAS/result/enrich_results_combined.csv") |>
  clean_names() |>
  rename(p_gamma = "gamma", 
         pathway = "x") |>
  filter(p_gamma < 0.05) |>
  mutate(logp = -log10(p_gamma), enrichment = hits_sig/expected) |>
  mutate(enrichment_disc = cut(enrichment, breaks = seq(0, 10, by = 2), 
                                 labels = c("< 2", "2 - <4", "4 - <6",
                                            "6 - <8", "8 - 10"))) |>
  filter(pathway_total > 3) |>
  filter((chemical == "BP-A" & mom_baby %in% c("Maternal", "Newborn")) |
         (chemical == "BP-S" & mom_baby == "Maternal") |
         (chemical == "2,5-DCP" & mom_baby == "Newborn") |
         (chemical == "MBP" & mom_baby == "Newborn") |
         (chemical == "MiBP" & mom_baby == "Maternal") |
         (chemical == "MBzP" & mom_baby == "Newborn")
         ) |>
  mutate(group = case_when(
    grepl("Vitamin|Ubiquinone|porphyrin", pathway, ignore.case = TRUE) ~ "Vitamin",
    grepl("fatty acid|Arachidonic|Carnitine|Phytanic|Glycerophospholipid|Linoleate", pathway, ignore.case = TRUE) ~ "Fatty acid",
    grepl("Pyrimidine|Purine", pathway, ignore.case = TRUE) ~ "Nucleotide",
    grepl("Methionine|Glutamate|Glycine|Beta-Alanine|Arginine|Glutathione|Aspartate|Lysine|Tyrosine|Alanine|Tryptophan|Histidine|Valine", 
          pathway, ignore.case = TRUE) ~ "Amino acid",
    grepl("Propanoate|C5-Branched|Starch|Pyruvate|Glycolysis|TCA|Starch|Pyruvate|Butanoate|Glyoxylate", 
          pathway, ignore.case = TRUE) ~ "Carbohydrate",
    grepl("Glycosphingolipid|Chondroitin|keratan|Heparan|Glycosphingolipid|N-Glycan|O-Glycan|Glycosphingolipid|Glycosphingolipid|Glycosphingolipid|N-Glycan||Chondroitin", 
          pathway, ignore.case = TRUE) ~ "Glycan",
    grepl("Nitrogen|Carbon|Nitrogen", pathway, ignore.case = TRUE) ~ "Energy",
    grepl("Galactose|Fructose|Pentose", pathway, ignore.case = TRUE) ~ "Sugar",
    TRUE ~ "other"
  ))

dat$group<- factor(dat$group, levels = c("Vitamin", "Amino acid", "Carbohydrate", "Glycan","Sugar", "Fatty acid", "Energy", "Nucleotide"))
```

```{r}
dat|>
  ggplot(aes(x = factor(chemical, levels = c("2,5-DCP", 
                                             "BP-A", "BP-S",
                                             "MBP", "MiBP", "MBzP")), 
             y = pathway)) + 
  geom_tile(aes(fill = factor(enrichment_disc)), color = "black") +
  scale_color_viridis(discrete = TRUE) +
  xlab("") +
  ylab("") +
  theme_bw() +
  theme(axis.text=element_text(size=10), 
        axis.title=element_text(size=10,face="bold"),
        strip.text = element_text(size=10),
        legend.text=element_text(size=10),
        legend.title=element_text(size=10),
        legend.position="bottom",
        legend.justification="right",
        legend.box="horizontal",
        legend.box.just="center",
        legend.margin=margin(t=0.1, r=0.1, b=2, l=0.1),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1, size = 10),
        axis.text.y = element_text(size = 10), 
        panel.spacing.x=unit(0.8, "lines"),
        panel.spacing.y=unit(0.02, "lines"),
        strip.text.y = element_blank()
        )+
  guides(fill = guide_legend(nrow = 1))+
  facet_grid(group~ mom_baby, scales = "free", switch = "y", space = "free")+
  labs(fill = "Enrichment factor")
```

```{r}
ggsave("~/Documents/phth_phe_MWAS/result/pathway_enrich.tiff", 
       width = 8, height = 12, dpi=300)
```

#Pathway overlap plots - data prep
```{r}
dat_olap <- dat |>
  unite(filename, chemical, mom_baby, sep = " ") |>
  dplyr::select(pathway, filename) |>
  distinct(pathway, filename, .keep_all=TRUE) |>
  unnest(cols = filename) |>
  mutate(GenreMember=1) |>
  pivot_wider(names_from = filename, values_from = GenreMember, values_fill = list(GenreMember = 0)) |>
  as.data.frame() |>
  dplyr::select(`2,5-DCP Newborn`, 
                `BP-A Newborn`, 
                `MBP Newborn`, 
                `MBzP Newborn`,
                `BP-A Maternal`, 
                `BP-S Maternal`, 
                `MiBP Maternal`)
```

#overlap plots
```{r}
upset(dat_olap, 
      keep.order = TRUE,
      nsets = 20,
      sets.bar.color = c("#0072B2", "#0072B2", "#0072B2", "#0072B2", "#E69F00", "#E69F00", "#E69F00"),
      sets = c("2,5-DCP Newborn", "BP-A Newborn", "MBP Newborn", "MBzP Newborn", "BP-A Maternal", "BP-S Maternal", "MiBP Maternal"),
      set_size.show = TRUE,
      text.scale = 1.5, point.size = 4, line.size = 1,
      mainbar.y.max = 8,
      set_size.scale_max = 73,
      mainbar.y.label="No.of pathways \noverlapped across chemical biomarkers",
      sets.x.label="Total no.of \naltered pathways")
```

#=============================================================================#
#=============================================================================#
#Pathway overlap plots - data prep
```{r}
dat_olap_crazy <- dat |>
  unite(filename, chemical, mom_baby, group, sep = " ") |>
  dplyr::select(pathway, filename) |>
  distinct(pathway, filename, .keep_all=TRUE) |>
  unnest(cols = filename) |>
  mutate(GenreMember=1) |>
  pivot_wider(names_from = filename, values_from = GenreMember, values_fill = list(GenreMember = 0)) |>
  as.data.frame() |>
  dplyr::select(`2,5-DCP Newborn Carbohydrate`,
`2,5-DCP Newborn Amino acid`,
`2,5-DCP Newborn Glycan`,
`2,5-DCP Newborn Vitamin`,
`2,5-DCP Newborn Nucleotide`,
`2,5-DCP Newborn Fatty acid`,
`BP-A Maternal Vitamin`,
`BP-A Maternal Glycan`,
`BP-A Maternal Amino acid`,
`BP-A Maternal Fatty acid`,
`BP-A Maternal Nucleotide`,
`BP-A Maternal Carbohydrate`,
`BP-A Newborn Glycan`,
`BP-A Newborn Carbohydrate`,
`BP-A Newborn Fatty acid`,
`BP-A Newborn Amino acid`,
`BP-A Newborn Vitamin`,
`BP-A Newborn Nucleotide`,
`BP-S Maternal Glycan`,
`BP-S Maternal Amino acid`,
`BP-S Maternal Nucleotide`,
`BP-S Maternal Vitamin`,
`BP-S Maternal Fatty acid`,
`BP-S Maternal Carbohydrate`,
`MBP Newborn Amino acid`,
`MBP Newborn Glycan`,
`MBP Newborn Vitamin`,
`MBP Newborn Carbohydrate`,
`MBP Newborn Fatty acid`,
`MBzP Newborn Glycan`,
`MBzP Newborn Vitamin`,
`MBzP Newborn Amino acid`,
`MBzP Newborn Fatty acid`,
`MBzP Newborn Carbohydrate`,
`MBzP Newborn Nucleotide`,
`MiBP Maternal Amino acid`,
`MiBP Maternal Glycan`,
`MiBP Maternal Carbohydrate`,
`MiBP Maternal Vitamin`,
`MiBP Maternal Nucleotide`,
`MiBP Maternal Fatty acid`
)
```

#overlap plots
```{r}
upset(dat_olap_crazy, 
      keep.order = TRUE,
      nsets = 10,
      sets.bar.color = c("#0072B2", "#0072B2", "#0072B2", "#0072B2","#0072B2", 
                         "#E69F00", "#E69F00", "#E69F00", "#E69F00", "#E69F00", "#E69F00",
                         "#009E73","#009E73","#009E73","#009E73","#009E73","#009E73",
                         "#56B4E9","#56B4E9","#56B4E9","#56B4E9","#56B4E9","#56B4E9",
                         "#FFD700","#FFD700","#FFD700","#FFD700","#FFD700","#FFD700",
                         "#FFA07A","#FFA07A","#FFA07A","#FFA07A","#FFA07A","#FFA07A",
                         "#9370DB", "#9370DB", "#9370DB", "#9370DB", "#9370DB","#9370DB"
                         ),
      sets = c("2,5-DCP Newborn Carbohydrate",
               "2,5-DCP Newborn Amino acid",
               "2,5-DCP Newborn Glycan",
               "2,5-DCP Newborn Vitamin",
               "2,5-DCP Newborn Nucleotide",
               "2,5-DCP Newborn Fatty acid",
"BP-A Maternal Vitamin",
"BP-A Maternal Glycan",
"BP-A Maternal Amino acid",
"BP-A Maternal Fatty acid",
"BP-A Maternal Nucleotide",
"BP-A Maternal Carbohydrate",
"BP-A Newborn Glycan",
"BP-A Newborn Carbohydrate",
"BP-A Newborn Fatty acid",
"BP-A Newborn Amino acid",
"BP-A Newborn Vitamin",
"BP-A Newborn Nucleotide",
"BP-S Maternal Glycan",
"BP-S Maternal Amino acid",
"BP-S Maternal Nucleotide",
"BP-S Maternal Vitamin",
"BP-S Maternal Fatty acid",
"BP-S Maternal Carbohydrate",
"MBP Newborn Amino acid",
"MBP Newborn Glycan",
"MBP Newborn Vitamin",
"MBP Newborn Carbohydrate",
"MBP Newborn Fatty acid",
"MBzP Newborn Glycan",
"MBzP Newborn Vitamin",
"MBzP Newborn Amino acid",
"MBzP Newborn Fatty acid",
"MBzP Newborn Carbohydrate",
"MBzP Newborn Nucleotide",
"MiBP Maternal Amino acid",
"MiBP Maternal Glycan",
"MiBP Maternal Carbohydrate",
"MiBP Maternal Vitamin",
"MiBP Maternal Nucleotide",
"MiBP Maternal Fatty acid"
),
      set_size.show = TRUE,
      text.scale = 1.5, point.size = 4, line.size = 1,
      mainbar.y.max = 6,
      set_size.scale_max = 40,
      mainbar.y.label="No.of pathways \noverlapped across chemical biomarkers",
      sets.x.label="Total no.of \naltered pathways")
```




